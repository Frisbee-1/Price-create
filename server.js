// ðŸ“¦ server.js â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… (Node.js)

// ========================
// 1. Ð˜ÐœÐŸÐžÐ Ð¢ ÐœÐžÐ”Ð£Ð›Ð•Ð™
// ========================
const express = require("express"); // Ð¡ÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€Ðº
const fs = require("fs"); // Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸
const cors = require("cors"); // Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð²

// ========================
// 2. ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð¡Ð•Ð Ð’Ð•Ð Ð
// ========================
const app = express(); // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Express
const PORT = 3001; // ÐŸÐ¾Ñ€Ñ‚, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€
const DATA_FILE = "data.json"; // ÐŸÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ, Ð³Ð´Ðµ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð´Ð°Ð½Ð½Ñ‹Ðµ

// ========================
// 3. MIDDLEWARE
// ========================
app.use(cors()); // Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ CORS (Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð¾Ð¼)
app.use(express.json()); // ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° JSON-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
app.use(express.static("public")); // Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)

// ========================
// 4. Ð—ÐÐ“Ð Ð£Ð—ÐšÐ Ð”ÐÐÐÐ«Ð¥
// ========================
app.get("/api/data", (req, res) => {
  // Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ â€” Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÐµÐ³Ð¾
  if (fs.existsSync(DATA_FILE)) {
    const data = fs.readFileSync(DATA_FILE); // Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» ÐºÐ°Ðº ÑÑ‚Ñ€Ð¾ÐºÑƒ
    res.json(JSON.parse(data)); // Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ð¾Ð±ÑŠÐµÐºÑ‚ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼
  } else {
    // Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð»Ð° Ð½ÐµÑ‚ â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
    res.json({
      materials: [],
      prices: {},
      synonyms: {},
      markupMap: {},
    });
  }
});

// ========================
// 5. Ð¡ÐžÐ¥Ð ÐÐÐ•ÐÐ˜Ð• Ð”ÐÐÐÐ«Ð¥
// ========================
app.post("/api/data", (req, res) => {
  // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ð¾Ð»Ñ Ð¸Ð· Ñ‚ÐµÐ»Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
  const { materials, prices, synonyms, markupMap } = req.body;

  // Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ñ…Ð¾Ñ‚Ð¸Ð¼ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ
  const data = { materials, prices, synonyms, markupMap };

  // ðŸ” Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼
  console.log("ðŸ“ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:", JSON.stringify(data, null, 2));

  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ñ„Ð°Ð¹Ð»
  fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2));

  // ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ
  res.json({ status: "ok" });
});

// ========================
// 6. Ð¡Ð¢ÐÐ Ð¢ Ð¡Ð•Ð Ð’Ð•Ð Ð
// ========================
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});
